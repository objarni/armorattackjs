<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>QUnit basic example</title>
  <link rel="stylesheet" href="http://code.jquery.com/qunit/qunit-1.18.0.css">
</head>
<body>
  <div id="qunit"></div>
  <div id="qunit-fixture"></div>
  <script src="http://code.jquery.com/qunit/qunit-1.18.0.js"></script>
  <script src="aagame.js"></script>
  <script src="fsmapp.js"></script>
  <script>

    /*
    AAGAme - the main game object of Armour Attack JS.
    States:
     TITLE
     INGAME
     DEAD
     GAMEOVER
     GAMEFINISHED
    Events:
     ControlDown left, right, fire, gas
     ControlUp     -    "    -
     PlayerHit
     NoMoreWaves
     Tick
    */
    QUnit.module( "AAGame - TITLE state" );

    QUnit.test( "is start state", function( assert ) {
      var aagame = AAGame();
      var state = aagame.getState();
      assert.equal( state, "TITLE", "Should start in TITLE state" );
    });
    
    QUnit.test( "transitions to ingame on control down", function( assert ) {
      var aagame = AAGame();
      aagame.handleEvent('ControlDown', 'left');
      var state = aagame.getState();
      assert.equal( state, "INGAME", "Should go to INGAME on key down" );
    });
    
    QUnit.module( "AAGame - INGAME state" );

    QUnit.test( "game finished event detected", function( assert ) {
      var aagame = AAGame();
      aagame.handleEvent('NoMoreWaves', null);
      var state = aagame.getState();
      assert.equal( state, "GAMEFINISHED", "Should go to GAMEFINISHED when no more waves are left" );
    });
    
    QUnit.test( "player starts with 3 jeeps", function( assert ) {
      var aagame = AAGame();
      assert.equal( aagame.getLives(), 0 );
      aagame.handleEvent( 'ControlDown', 'right' );
      assert.equal( aagame.getLives(), 3 );
    });
    
    QUnit.test( "lives decrease when player hit", function( assert ) {
      var aagame = AAGame();
      aagame.handleEvent( 'ControlDown', 'fire' );
      aagame.handleEvent( 'PlayerHit', null );
      assert.equal( aagame.getLives(), 2 );
    });
    
    QUnit.test( "goes to DEAD state when hit and more than 0 lives left", function( assert ) {
      var aagame = AAGame();
      aagame.handleEvent( 'PlayerHit', null );
      assert.equal( aagame.getState(), 'DEAD' );
    });
    
    QUnit.test( "goes to GAMEOVER state when hit and 0 lives left", function( assert ) {
      var aagame = AAGame();
      aagame.handleEvent( 'ControlDown', 'fire' );
      aagame.handleEvent( 'PlayerHit', null );
      aagame.handleEvent( 'PlayerHit', null );
      aagame.handleEvent( 'PlayerHit', null );
      assert.equal( aagame.getState(), 'GAMEOVER' );
    });


    /*
      FSMApp - qp inspired FSM running object.
      Features:
        add/remove machines in runtime
        0 or more machines
        handleEvent propages to all machines
        public API to publish events, add/remove machines
    */

    QUnit.module( "FSAMApp" );

    QUnit.test( "event is propagated to every machine", function( assert ) {
      var calls = 0;
      var m1 = { handleEvent: function(sig, par) { calls++; }};
      var m2 = { handleEvent: function(sig, par) { calls++; }};
      var app = FSMApp();
      app.addMachine(m1);
      app.addMachine(m2);
      app.handleEvent('testsignal', null);
      assert.equal( 2, calls, 'Should propagate event to every machine');
    });
    
    QUnit.test( "removed machine does not get events anymore", function( assert ) {
      var calls = 0;
      var m = { handleEvent: function(sig, par) { calls++; }};
      var app = FSMApp();
      app.addMachine(m);
      app.handleEvent('testsignal', null);
      app.removeMachine(m);
      app.handleEvent('testsignal', null);
      assert.equal( 1, calls, 'Should not propagate events to removed machine');
    });
        
    QUnit.test( "removing non-added machine throws", function( assert ) {
      var calls = 0;
      var m = { handleEvent: function(sig, par) { calls++; }};
      var app = FSMApp();
      assert.throws(function() { app.removeMachine(m) }, 'Should throw if removing non-added machine');
    });
    
    setTimeout(function() { location.reload() }, 2000);
  </script>
  <a href="index.html">Back to Armor Attack</a>
</body>
</html>